package main

import (
	"my-tls"
	"fmt"
	"os"
	"strings"
)

func main() {
	if len(os.Args) != 2 {
		fmt.Fprintf(os.Stderr, "Please give hostname (and, optionally, a port) as the only argument.\n")
		os.Exit(9)
	}

	target := os.Args[1]
	if !strings.Contains(target, ":") {
		target += ":443"
	}

	conn, err := tls.Dial("tcp", target, &tls.Config{InsecureSkipVerify: true, MaxVersion: tls.VersionTLS10})
	if err != nil {
		fmt.Printf("\x1b[33mNormal handshake failed. Cannot test.\x1b[0m\n")
		os.Exit(9)
	}
	conn.Close()

	conn, err = tls.Dial("tcp", target, &tls.Config{InsecureSkipVerify: true, EarlyCCS: 1})
	if err == nil {
		fmt.Printf("\x1b[31mServer is affected (1.0.1).\x1b[0m\n")
		os.Exit(1)
	}

	conn, err = tls.Dial("tcp", target, &tls.Config{InsecureSkipVerify: true, EarlyCCS: 2})
	if err == nil {
		fmt.Printf("\x1b[31mServer is affected (0.9.8 or 1.0.0).\x1b[0m\n")
		os.Exit(2)
	}

	fmt.Fprintf(os.Stderr, "Handshake failed with error: %s\n", err)
	fmt.Printf("\x1b[32mLooks ok.\x1b[0m\n")
	os.Exit(0)
}
